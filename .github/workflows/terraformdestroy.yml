terraform-destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    needs: terraform-destroy-plan
    timeout-minutes: 60
    environment:
      name: juiceshop-destruction
      url: https://console.aws.amazon.com
    permissions:
      contents: read
      id-token: write
      issues: write
    
    steps:
      - name: Final Warning
        run: |
          echo "âš ï¸âš ï¸âš ï¸ FINAL WARNING âš ï¸âš ï¸âš ï¸"
          echo ""
          echo "Destroying Juice Shop infrastructure in 10 seconds..."
          echo "This action is IRREVERSIBLE!"
          sleep 10

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-JuiceShop-Destroy

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -input=false

      - name: Download Destroy Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-destroy-plan
          path: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Destroy
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          TF_VAR_alert_email: ${{ secrets.TF_VAR_ALERT_EMAIL }}
          TF_VAR_key_name: ${{ secrets.TF_VAR_KEY_NAME }}
          TF_VAR_logs_bucket_name: ${{ secrets.TF_VAR_LOGS_BUCKET_NAME }}
          TF_VAR_my_ip_cidr: ${{ secrets.TF_VAR_MY_IP_CIDR }}
        run: |
          echo "ðŸ—‘ï¸ Executing destroy..."
          terraform apply -auto-approve destroy.tfplan 2>&1 | tee destroy_output.txt
          echo "âœ… Destroy completed"

      - name: Save Destroy Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-destroy-output
          path: ${{ env.TF_WORKING_DIR }}/destroy_output.txt
          retention-days: 90

      - name: Post Destroy Summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const destroyOutput = fs.existsSync('terraform/destroy_output.txt') ? 
              fs.readFileSync('terraform/destroy_output.txt', 'utf8') : 
              'Output not available';
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âœ… Juice Shop Infrastructure Destroyed',
              body: `## Destruction Completed
              
              **Executed by:** @${{ github.actor }}
              **Date:** ${new Date().toISOString()}
              **Status:** ${{ job.status }}
              **Workflow:** [View Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              <details><summary>Destruction Log</summary>
              
              \`\`\`
              ${destroyOutput.substring(0, 65000)}
              \`\`\`
              
              </details>
              
              ### Post-Destruction Checklist
              
              - [ ] Verify AWS resources deleted
              - [ ] Check for orphaned resources
              - [ ] Review AWS billing
              - [ ] Update documentation
              
              **Labels:** infrastructure, destroyed, juice-shop`,
              labels: ['infrastructure', 'destroyed', 'juice-shop']
            });

      - name: Success Notification
        if: success()
        run: |
          echo "âœ… Juice Shop infrastructure destroyed successfully!"
          echo "Verify in AWS Console: https://console.aws.amazon.com"
