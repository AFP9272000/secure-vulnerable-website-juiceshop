name: Juice Shop Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "DESTROY" to confirm destruction of Juice Shop infrastructure'
        required: true
        type: string
      target:
        description: 'Destroy specific resource (optional - leave empty to destroy all)'
        required: false
        type: string

env:
  TF_VERSION: 1.6.0
  AWS_REGION: us-east-2

jobs:
  validate-destroy-request:
    name: Validate Destroy Request
    runs-on: ubuntu-latest
    steps:
      - name: Check Confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "DESTROY" ]; then
            echo "❌ Confirmation failed. You must type 'DESTROY' exactly to proceed."
            exit 1
          fi
          echo "✅ Destroy confirmation validated"
          
      - name: Display Warning
        run: |
          echo "⚠️⚠️⚠️ WARNING ⚠️⚠️⚠️"
          echo ""
          echo "This will destroy the Juice Shop infrastructure"
          echo ""
          echo "Initiated by: ${{ github.actor }}"

  terraform-destroy-plan:
    name: Terraform Destroy Plan
    runs-on: ubuntu-latest
    needs: validate-destroy-request
    timeout-minutes: 30
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-JuiceShop-DestroyPlan

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: terraform
        run: terraform init -input=false

      - name: Terraform Destroy Plan
        id: destroy_plan
        working-directory: terraform
        env:
          TF_VAR_alert_email: ${{ secrets.TF_VAR_ALERT_EMAIL }}
          TF_VAR_key_name: ${{ secrets.TF_VAR_KEY_NAME }}
          TF_VAR_logs_bucket_name: ${{ secrets.TF_VAR_LOGS_BUCKET_NAME }}
          TF_VAR_my_ip_cidr: ${{ secrets.TF_VAR_MY_IP_CIDR }}
        run: |
          terraform plan -destroy -no-color -input=false -out=destroy.tfplan
          echo "exitcode=$?" >> $GITHUB_OUTPUT

      - name: Save Destroy Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-destroy-plan
          path: terraform/destroy.tfplan
          retention-days: 7

  terraform-destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    needs: terraform-destroy-plan
    timeout-minutes: 60
    environment:
      name: juiceshop-destruction
      url: https://console.aws.amazon.com
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Final Warning
        run: |
          echo "⚠️ Destroying in 10 seconds..."
          sleep 10

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-JuiceShop-Destroy

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: terraform
        run: terraform init -input=false

      - name: Download Destroy Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-destroy-plan
          path: terraform

      - name: Terraform Destroy
        working-directory: terraform
        env:
          TF_VAR_alert_email: ${{ secrets.TF_VAR_ALERT_EMAIL }}
          TF_VAR_key_name: ${{ secrets.TF_VAR_KEY_NAME }}
          TF_VAR_logs_bucket_name: ${{ secrets.TF_VAR_LOGS_BUCKET_NAME }}
          TF_VAR_my_ip_cidr: ${{ secrets.TF_VAR_MY_IP_CIDR }}
        run: terraform apply -auto-approve destroy.tfplan

      - name: Success
        if: success()
        run: echo "✅ Infrastructure destroyed!"
